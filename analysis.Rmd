---
title: "L&L Metaanalysis"
author: "Saurabh Khanna"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(metafor)
library(readxl)

# Parameters
data_file <- here::here("data/L&L Data Set Means SDs.xlsx")

```

## Reading in data

```{r}
# join checks
read_xlsx(data_file, sheet = "VR") %>% 
  select(AUTYR) %>% 
  drop_na(AUTYR) %>% 
  anti_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      select(AUTYR) %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  )
```

All good!

## Calculate effect sizes

### R studies

#### RR studies

```{r}
df_rr_post <-
  read_xlsx(data_file, sheet = "RR") %>% 
  rename_at(vars(-AUTYR), ~ str_replace(., "RR", "")) %>% 
  filter(is.na(T1M1pre), is.na(T1S1pre)) %>%
  select_if(~ any(!is.na(.))) %>%
  select(AUTYR, sort(current_vars()))

for (t in 1:4) {
  for (c in 1:4) {
    for (m in 1:4) {
      if (
        !(str_glue("T{t}M{m}post") %in% colnames(df_rr_post)) | 
        !(str_glue("C{c}M{m}post") %in% colnames(df_rr_post))
      ) {
        next
      }
      df_rr_post <-
        escalc(
          data = df_rr_post,
          measure = "SMD",
          m1i = df_rr_post[, str_c("T", t, "M", m, "post")] %>% unlist(),
          m2i = df_rr_post[, str_c("C", c, "M", m, "post")] %>% unlist(),
          sd1i = df_rr_post[, str_c("T", t, "S", m, "post")] %>% unlist(),
          sd2i = df_rr_post[, str_c("C", c, "M", m, "post")] %>% unlist(),
          n1i = df_rr_post[, str_c("T", t, "N", m, "post")] %>% unlist(),
          n2i = df_rr_post[, str_c("C", c, "N", m, "post")] %>% unlist(),
          var.names = c(str_glue("ES_T{t}M{m}_C{c}M{m}"), str_glue("EV_T{t}M{m}_C{c}M{m}"))
        ) 
    }
  }
}

df_rr_post <- 
  df_rr_post %>% 
  select(AUTYR, starts_with("E"))

df_rr_post
```


