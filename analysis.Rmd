---
title: "Meta-analysis Script"
author: "Saurabh Khanna"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.retina = 4)
```

```{r}
# Libraries
library(tidyverse)
library(readxl)
library(metafor)
library(MAd)
library(metaforest)
library(dmetar)
library(DT)
library(robumeta)

# Parameters
data_file <- here::here("data", "L&L Data Set Means SDs.xlsx")
```


## Reading in data

```{r}
# join checks
read_xlsx(data_file, sheet = "VR") %>% 
  select(AUTYR) %>% 
  drop_na(AUTYR) %>% 
  anti_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      select(AUTYR) %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  )

read_xlsx(data_file, sheet = "VS") %>% 
  select(AUTYR) %>% 
  drop_na(AUTYR) %>% 
  anti_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      select(AUTYR) %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  )

read_xlsx(data_file, sheet = "LR") %>% 
  select(AUTYR) %>% 
  drop_na(AUTYR) %>% 
  anti_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      select(AUTYR) %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  )

read_xlsx(data_file, sheet = "LS") %>% 
  select(AUTYR) %>% 
  drop_na(AUTYR) %>% 
  anti_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      select(AUTYR) %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  )

read_xlsx(data_file, sheet = "RR") %>% 
  select(AUTYR) %>% 
  drop_na(AUTYR) %>% 
  anti_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      select(AUTYR) %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  )

read_xlsx(data_file, sheet = "RS") %>% 
  select(AUTYR) %>% 
  drop_na(AUTYR) %>% 
  anti_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      select(AUTYR) %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  )

read_xlsx(data_file, sheet = "DS") %>% 
  select(AUTYR) %>% 
  drop_na(AUTYR) %>% 
  anti_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      select(AUTYR) %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  )
```

All good!


## Calculate effect sizes

### Post only

```{r}
df_post <-
  bind_rows(
    "VR" = read_xlsx(data_file, sheet = "VR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "VR", "")),
    "VS" = read_xlsx(data_file, sheet = "VS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "VS", "")),
    "RR" = read_xlsx(data_file, sheet = "RR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "RR", "")),
    "RS" = read_xlsx(data_file, sheet = "RS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "RS", "")),
    "LR" = read_xlsx(data_file, sheet = "LR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "LR", "")),
    "LS" = read_xlsx(data_file, sheet = "LS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "LS", "")),
    "MR" = read_xlsx(data_file, sheet = "MR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "MR", "")),
    #"MS" = read_xlsx(data_file, sheet = "MS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "MS", "")),
    #"SR" = read_xlsx(data_file, sheet = "SR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "SR", "")),
    "SS" = read_xlsx(data_file, sheet = "SS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "SS", "")),
    "AS" = read_xlsx(data_file, sheet = "AS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "AS", "")),
    "DS" = read_xlsx(data_file, sheet = "DS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "DS", "")),
    .id = "type"
  ) %>% 
  drop_na(AUTYR) %>%
  filter(is.na(TM1pre)) %>% 
  select_if(~ any(!is.na(.))) %>%
  select(AUTYR, type, sort(current_vars()))


for (m in 1:5) {
  if (
    !(str_glue("TM{m}post") %in% colnames(df_post)) | 
    !(str_glue("CM{m}post") %in% colnames(df_post))
  ) {
    next
  }
  df_post <-
    escalc(
      data = df_post,
      measure = "SMD",
      m1i = df_post[, str_c("TM", m, "post")] %>% unlist(),
      m2i = df_post[, str_c("CM", m, "post")] %>% unlist(),
      sd1i = df_post[, str_c("TS", m, "post")] %>% unlist(),
      sd2i = df_post[, str_c("CS", m, "post")] %>% unlist(),
      n1i = df_post[, str_c("TN", m, "post")] %>% unlist(),
      n2i = df_post[, str_c("CN", m, "post")] %>% unlist(),
      var.names = c(str_glue("ES_{m}"), str_glue("EV_{m}"))
    ) 
}


df_post <-
  df_post %>% 
  select(AUTYR, type, starts_with("ES")) %>% 
  pivot_longer(cols = starts_with("ES"), names_to = "num", values_to = "ES", values_drop_na = T) %>%
  mutate(num = str_sub(num, 4)) %>% 
  left_join(
    df_post %>% 
      select(AUTYR, type, starts_with("EV")) %>% 
      pivot_longer(cols = starts_with("EV"), names_to = "num", values_to = "EV", values_drop_na = T) %>% 
      mutate(num = str_sub(num, 4)),
    by = c("AUTYR", "type", "num")
  ) %>% 
  select(-num)
  
```


### Pre and Post

```{r}
df_prepost <-
  bind_rows(
    "VR" = read_xlsx(data_file, sheet = "VR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "VR", "")),
    "VS" = read_xlsx(data_file, sheet = "VS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "VS", "")),
    "RR" = read_xlsx(data_file, sheet = "RR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "RR", "")),
    "RS" = read_xlsx(data_file, sheet = "RS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "RS", "")),
    "LR" = read_xlsx(data_file, sheet = "LR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "LR", "")),
    "LS" = read_xlsx(data_file, sheet = "LS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "LS", "")),
    "MR" = read_xlsx(data_file, sheet = "MR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "MR", "")),
  # "MS" = read_xlsx(data_file, sheet = "MS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "MS", "")),
  # "SR" = read_xlsx(data_file, sheet = "SR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "SR", "")),
    "SS" = read_xlsx(data_file, sheet = "SS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "SS", "")),
    "AS" = read_xlsx(data_file, sheet = "AS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "AS", "")),
    "DS" = read_xlsx(data_file, sheet = "DS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "DS", "")),
    .id = "type"
  ) %>% 
  drop_na(AUTYR) %>%
  filter(!is.na(TM1pre)) %>% 
  select_if(~ any(!is.na(.))) %>%
  select(AUTYR, type, sort(current_vars())) %>% 
  mutate(
    TN1post = if_else(is.na(TN1post) & !is.na(TN1pre), TN1pre, TN1post),
    TN2post = if_else(is.na(TN2post) & !is.na(TN2pre), TN2pre, TN2post),
    CN1post = if_else(is.na(CN1post) & !is.na(CN1pre), CN1pre, CN1post),
    CN2post = if_else(is.na(CN2post) & !is.na(CN2pre), CN2pre, CN2post)
  )


# treatment (post-pre)
for (mt in 1:4) {
  if (
    !(str_glue("TM{mt}post") %in% colnames(df_prepost)) | 
    !(str_glue("TM{mt}pre") %in% colnames(df_prepost))
  ) {
    next
  }
  df_prepost <-
    escalc(
      data = df_prepost,
      measure = "SMCR",
      m1i = df_prepost[, str_c("TM", mt, "post")] %>% unlist(),
      m2i = df_prepost[, str_c("TM", mt, "pre")] %>% unlist(),
      sd1i = df_prepost[, str_c("TS", mt, "pre")] %>% unlist(),
      ni = df_prepost[, str_c("TN", mt, "post")] %>% unlist(),
      ri = rep(0.5, 94),
      var.names = c(str_glue("TES_TM{mt}"), str_glue("TEV_TM{mt}"))
    ) 
}

# control (post-pre)
for (mc in 1:4) {
  if (
    !(str_glue("CM{mc}post") %in% colnames(df_prepost)) | 
    !(str_glue("CM{mc}pre") %in% colnames(df_prepost))
  ) {
    next
  }
  df_prepost <-
    escalc(
      data = df_prepost,
      measure = "SMCR",
      m1i = df_prepost[, str_c("CM", mc, "post")] %>% unlist(),
      m2i = df_prepost[, str_c("CM", mc, "pre")] %>% unlist(),
      sd1i = df_prepost[, str_c("CS", mc, "pre")] %>% unlist(),
      ni = df_prepost[, str_c("CN", mc, "post")] %>% unlist(),
      ri = rep(0.5, 94),
      var.names = c(str_glue("CES_CM{mc}"), str_glue("CEV_CM{mc}"))
    ) 
}


# ES and EV taken together
for (m in 1:4) {
  if (
    !(str_glue("TES_TM{m}") %in% colnames(df_prepost)) | 
    !(str_glue("TEV_TM{m}") %in% colnames(df_prepost)) |
    !(str_glue("CES_CM{m}") %in% colnames(df_prepost)) | 
    !(str_glue("CEV_CM{m}") %in% colnames(df_prepost))
  ) {
    next
  }
  # subtracting effect size
  df_prepost[, str_c("ES_", m)] <- 
    (df_prepost[, str_c("TES_TM", m)] %>% unlist()) -
    (df_prepost[, str_c("CES_CM", m)] %>% unlist())
  # adding variance
  df_prepost[, str_c("EV_", m)] <- 
    (df_prepost[, str_c("TEV_TM", m)] %>% unlist()) +
    (df_prepost[, str_c("CEV_CM", m)] %>% unlist())
}


df_prepost <-
  df_prepost %>% 
  select(AUTYR, type, starts_with("ES")) %>% 
  pivot_longer(cols = starts_with("ES"), names_to = "num", values_to = "ES", values_drop_na = T) %>%
  mutate(num = str_sub(num, 4)) %>% 
  left_join(
    df_prepost %>% 
      select(AUTYR, type, starts_with("EV")) %>% 
      pivot_longer(cols = starts_with("EV"), names_to = "num", values_to = "EV", values_drop_na = T) %>% 
      mutate(num = str_sub(num, 4)),
    by = c("AUTYR", "type", "num")
  ) %>% 
  select(-num)
```


### Directly entered ES

```{r}
df_es_direct <-
  tribble(
    ~AUTYR,        ~type, ~ES, ~EV,
    
    # "Apthorp12_K", "VR",  0.98, 0,
    # "Apthorp12_1", "VR",  1.00, 0,
    # "Apthorp12_3", "VR",  0.95, 0,
    # "Apthorp12_4", "VR",  1.24, 0,
    
    # "Apthorp12_P", "VS",  0.06, 0,
    # "Apthorp12_I", "VS", -0.14, 0,
    "Gersten10",   "VS",  0.33, 0.05,
    "Jayanthi18",  "VS", -0.043, 0.001,

    # "Apthorp12_K", "LR",  0.24, 0,
    # "Apthorp12_1", "LR",  0.21, 0,
    # 
    # "Apthorp12_P", "LS",  0.05, 0,
    # 
    # "Apthorp12_3", "RR",  0.09, 0,
    # "Apthorp12_4", "RR",  0.44, 0,
    # 
    # "Apthorp12_I", "RS", -0.11, 0,
    "Gersten10",   "RS",  0.13, 0.04
  )
```

### Combining all

```{r, fig.retina=4}
df_append <- 
  bind_rows(df_post, df_prepost, df_es_direct) %>% 
  left_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      drop_na(AUTYR) %>% 
      fill(Performance, Detection, Attrition, Reporting),
    by = "AUTYR"
  ) %>%
  mutate(
    LowIncome = recode(LowIncome, "0" = "0", "1" = "1", .default = NA_character_) %>% as.integer(),
    Hours = Hours %>% parse_number(),
    CONT = recode(CONT, "BAU" = "0", "ALT" = "1") %>% as.integer()
  ) %>%
  arrange(type, stdid) %>%
  select(type, stdid, AUTYR, everything())
  
cor_es <-
  df_append %>%
  unite("type_stdid", c("type", "stdid")) %>% 
  agg(id = type_stdid, es = ES, var = EV, method = "BHHR", data = .) %>% 
  separate(id, c("type", "stdid")) %>% 
  rename(ES = es, EV = var)

df_clean <-
  df_append %>%
  group_by(type, stdid) %>%
  summarize_at(vars(Content:Hours), ~ round(mean(.))) %>%
  ungroup() %>%
  left_join(cor_es, by = c("type", "stdid")) %>% 
  select(type, stdid, ES, EV, everything()) %>% 
  mutate(
    design = case_when(
      RCT == 1 ~ "RCT",
      QED == 1 ~ "QED",
      WSD == 1 ~ "WSD",
      TRUE ~ NA_character_
    ) %>% as_factor(),
    grade = case_when(
      (GradeK + Grade1 + Grade2) > 0 & (Grade3 + Grade4 + Grade5) == 0 ~ "K-2",
      (Grade3 + Grade4 + Grade5) > 0 & (GradeK + Grade1 + Grade2) == 0 ~ "3-5",
      TRUE ~ "Both"
    ) %>% as_factor(),
    grouping = case_when(
      (WholeCl == 1) & (SmallGr == 0) & (Indiv == 0) ~ 1,
      TRUE ~ 0
    ),
    CONT = CONT %>% factor(labels = c("BAU", "ALT")),
    TCOM = if_else(TLC == 1 | TRC == 1, 1, 0)
  ) %>%
  select(-c(RCT, QED, WSD, WholeCl, SmallGr, Indiv), -starts_with("Grade", ignore.case = F)) %>% 
  left_join(
    read_xlsx(data_file, sheet = "citations"),
    by = c("type", "stdid")
  ) %>% 
  mutate(
    type = type %>% as_factor(),
    citation = if_else(str_detect(type, "S$"), str_c(citation, " "), citation)
  )

rm(df_post, df_prepost, df_es_direct)
df_clean %>% summary()
df_clean %>% datatable()
```

### Summary stats

```{r}
df_clean %>% count(stdid)
#df_clean %>% arrange(type, ES) %>% writexl::write_xlsx("df_clean.xlsx")
#df_clean %>% select(stdid, type) %>% arrange(stdid, type) %>% writexl::write_xlsx("temp.xlsx")
df_clean %>% count(type, stdid)

df_v <- df_clean %>% filter(type %in% c("VR", "VS"))
df_l <- df_clean %>% filter(type %in% c("LR", "LS"))
df_r <- df_clean %>% filter(type %in% c("RR", "RS"))
df_m <- df_clean %>% filter(type %in% c("MR", "MS"))
df_s <- df_clean %>% filter(type %in% c("SR", "SS"))
df_a <- df_clean %>% filter(type == "AS")
df_d <- df_clean %>% filter(type == "DS")

# changes for rebecca
# df_v %>% filter(stdid %in% c("Coyne10", "Coyne19", "Puhal", "Pullen"), type == "VR") %>% rma(
#     yi = ES, 
#     vi = EV, 
#     data = ., 
#     method = "REML",
#     slab = citation
#   )
```


## Synthesizing effect sizes

### Vocabulary

```{r}
model_1 <-
  df_v %>%
  arrange(desc(type), desc(ES)) %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation
  )

model_2 <-
  df_v %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    subset = (type == "VR"),
    slab = stdid
  )

model_3 <-
  df_v %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    subset = (type == "VS"),
    slab = stdid
  )

model_1
model_2
model_3
df_v %>% count(type)
#boxplot(df_v$ES, plot=FALSE)$out
```

```{r,  out.width="100%", out.height="100%", fig.asp=2.25, fig.retina = 4}
forest(
  model_1,
  xlab = "Vocabulary",
  addcred = T, 
  header = T,
  xlim = c(-15, 18),
  ylim = c(-1, 85),
  rows = c(3:26, 34:77),
  pch = 21,
  bg = "grey",
  lwd = 1.5
)
op <- par(cex = 0.75, font = 4)
text(-15, c(29, 80), pos = 4, c("Standardized Measure", "Custom Measure"))
addpoly(model_2, row = 32, cex = 1.25, col = "white", lwd = 3)
addpoly(model_3, row = 1.5, cex = 1.25, col = "white", lwd = 3)
```


### Listening Comprehension


```{r, out.width="100%", out.height="100%", fig.asp=2}
# Combined
model_1 <-
  df_l %>%
  arrange(desc(type), desc(ES)) %>%  
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation
  )

# Custom (all distal)
model_2 <-
  df_l %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    subset = (type == "LR"),
    slab = stdid
  )

# Standardized
model_3 <-
  df_l %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    subset = (type == "LS"),
    slab = stdid
  )

model_1
model_2
model_3
df_l %>% count(type)
```

```{r,  out.width="100%", out.height="100%", fig.asp=1, fig.retina = 4}
forest(
  model_1,
  xlab = "Listening Comprehension",
  addcred = T, 
  header = T,
  ylim = c(-1, 26),
  rows = c(3:8, 15:20),
  pch = 21,
  bg = "grey",
  lwd = 1.5
)
op <- par(cex = 0.75, font = 4)
text(-2.5, c(10, 22), pos = 4, c("Standardized Measure", "Custom Measure"))
addpoly(model_2, row = 13, cex = 1.25, col = "white", lwd = 3)
addpoly(model_3, row = 1.5, cex = 1.25, col = "white", lwd = 3)
```



### Reading Comprehension


```{r, out.width="100%", out.height="100%", fig.asp=2}
model_1 <-
  df_r %>%
  arrange(desc(type), desc(ES)) %>%  
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation
  )

# Custom (all)
model_2 <-
  df_r %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    subset = (type == "RR"),
    slab = stdid
  )

# Custom (proximal)
model_3 <-
  df_r %>%
  filter(type == "RR", stdid != "Silver17a4") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = stdid
  )

# Custom (distal)
model_4 <-
  df_r %>%
  filter(type == "RR", stdid == "Silver17a4") %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = stdid
  )

# Standardized
model_5 <-
  df_r %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    subset = (type == "RS"),
    slab = stdid
  )

model_1  #overall
model_2  #custom
model_3  #proximal custom
model_4  #distal custom
model_5  #standardized
df_r %>% count(type)
```

```{r,  out.width="100%", out.height="100%", fig.asp=1.25, fig.retina = 4}
forest(
  model_1,
  xlab = "Reading Comprehension",
  addcred = T, 
  header = T,
  ylim = c(-1, 35),
  rows = c(3:19, 27:29),
  pch = 21,
  bg = "grey",
  lwd = 1.5
)
op <- par(cex = 0.75, font = 4)
text(-3.6, c(21, 31), pos = 4, c("Standardized Measure", "Custom Measure"))
addpoly(model_2, row = 24, cex = 1.25, col = "white", lwd = 3)
addpoly(model_5, row = 1, cex = 1.25, col = "white", lwd = 3)
```


### Morphology

```{r, fig.retina = 4}
df_m %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = stdid
  )

# Custom (distal)
df_m %>%
  filter(stdid != "Brimo") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = stdid
  )

# Custom (proximal)
df_m %>%
  filter(stdid == "Brimo") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = stdid
  )

df_m %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation
  ) %>% 
  forest(
    order = "obs",
    xlab = "Morphology",
    addcred = T, 
    header = T,
    pch = 21,
    bg = "grey",
    lwd = 1.5
  )
```

### Syntax

```{r, fig.retina = 4}
df_s %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = stdid
  )

df_s %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation
  ) %>% 
  forest(
    order = "obs",
    xlab = "Syntax",
    addcred = T, 
    header = T,
    pch = 21,
    bg = "grey",
    lwd = 1.5
  )
```

### Academic Learning


```{r, fig.retina = 4}
df_a %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = stdid
  )

df_a %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation
  ) %>% 
  forest(
    order = "obs",
    xlab = "Academic Learning",
    addcred = T, 
    header = T,
    pch = 21,
    bg = "grey",
    lwd = 1.5
  )
```


### Decoding measures


```{r, fig.retina = 4}
df_d %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_d %>%
  left_join(read_xlsx(data_file, sheet = "citations") %>% distinct(stdid, citation), by = "stdid") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation.y
  ) %>% 
  forest(
    order = "obs",
    xlab = "Decoding Measures",
    addcred = T, 
    header = T,
    pch = 21,
    bg = "grey",
    xlim = c(-5, 4),
    lwd = 1.5
  )
```


## Delayed Tests Analysis

### Calculate ES
#### Delay only

```{r}
df_delay <-
  bind_rows(
    "VR" = read_xlsx(data_file, sheet = "VR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "VR", "")),
    "VS" = read_xlsx(data_file, sheet = "VS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "VS", "")),
    "RR" = read_xlsx(data_file, sheet = "RR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "RR", "")),
    "RS" = read_xlsx(data_file, sheet = "RS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "RS", "")),
    "LR" = read_xlsx(data_file, sheet = "LR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "LR", "")),
    "LS" = read_xlsx(data_file, sheet = "LS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "LS", "")),
    "MR" = read_xlsx(data_file, sheet = "MR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "MR", "")),
    #"MS" = read_xlsx(data_file, sheet = "MS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "MS", "")),
    #"SR" = read_xlsx(data_file, sheet = "SR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "SR", "")),
    "SS" = read_xlsx(data_file, sheet = "SS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "SS", "")),
    "AS" = read_xlsx(data_file, sheet = "AS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "AS", "")),
    .id = "type"
  ) %>% 
  drop_na(AUTYR) %>%
  filter(!is.na(TM1delay) & is.na(TM1pre)) %>% 
  select_if(~ any(!is.na(.))) %>%
  select(AUTYR, type, sort(current_vars()))


for (m in 1:4) {
  if (
    !(str_glue("TM{m}delay") %in% colnames(df_delay)) | 
    !(str_glue("CM{m}delay") %in% colnames(df_delay))
  ) {
    next
  }
  df_delay <-
    escalc(
      data = df_delay,
      measure = "SMD",
      m1i = df_delay[, str_c("TM", m, "delay")] %>% unlist(),
      m2i = df_delay[, str_c("CM", m, "delay")] %>% unlist(),
      sd1i = df_delay[, str_c("TS", m, "delay")] %>% unlist(),
      sd2i = df_delay[, str_c("CS", m, "delay")] %>% unlist(),
      n1i = df_delay[, str_c("TN", m, "delay")] %>% unlist(),
      n2i = df_delay[, str_c("CN", m, "delay")] %>% unlist(),
      var.names = c(str_glue("ES_{m}"), str_glue("EV_{m}"))
    ) 
}


df_delay <-
  df_delay %>% 
  select(AUTYR, type, starts_with("ES")) %>% 
  pivot_longer(cols = starts_with("ES"), names_to = "num", values_to = "ES", values_drop_na = T) %>%
  mutate(num = str_sub(num, 4)) %>% 
  left_join(
    df_delay %>% 
      select(AUTYR, type, starts_with("EV")) %>% 
      pivot_longer(cols = starts_with("EV"), names_to = "num", values_to = "EV", values_drop_na = T) %>% 
      mutate(num = str_sub(num, 4)),
    by = c("AUTYR", "type", "num")
  ) %>% 
  select(-num)
```


#### Pre-Delay
```{r}
df_predelay <-
  bind_rows(
    "VR" = read_xlsx(data_file, sheet = "VR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "VR", "")),
    "VS" = read_xlsx(data_file, sheet = "VS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "VS", "")),
    "RR" = read_xlsx(data_file, sheet = "RR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "RR", "")),
    "RS" = read_xlsx(data_file, sheet = "RS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "RS", "")),
    "LR" = read_xlsx(data_file, sheet = "LR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "LR", "")),
    "LS" = read_xlsx(data_file, sheet = "LS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "LS", "")),
    "MR" = read_xlsx(data_file, sheet = "MR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "MR", "")),
    #"MS" = read_xlsx(data_file, sheet = "MS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "MS", "")),
    #"SR" = read_xlsx(data_file, sheet = "SR") %>% rename_at(vars(-AUTYR), ~ str_replace(., "SR", "")),
    "SS" = read_xlsx(data_file, sheet = "SS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "SS", "")),
    "AS" = read_xlsx(data_file, sheet = "AS") %>% rename_at(vars(-AUTYR), ~ str_replace(., "AS", "")),
    .id = "type"
  ) %>% 
  drop_na(AUTYR) %>%
  filter(!is.na(TM1delay)) %>% 
  select_if(~ any(!is.na(.))) %>%
  select(AUTYR, type, sort(current_vars()))


# treatment (delay-pre)
for (mt in 1:4) {
  if (
    !(str_glue("TM{mt}delay") %in% colnames(df_predelay)) | 
    !(str_glue("TM{mt}pre") %in% colnames(df_predelay))
  ) {
    next
  }
  df_predelay <-
    escalc(
      data = df_predelay,
      measure = "SMCR",
      m1i = df_predelay[, str_c("TM", mt, "delay")] %>% unlist(),
      m2i = df_predelay[, str_c("TM", mt, "pre")] %>% unlist(),
      sd1i = df_predelay[, str_c("TS", mt, "pre")] %>% unlist(),
      ni = df_predelay[, str_c("TN", mt, "delay")] %>% unlist(),
      ri = rep(0.5, 13),
      var.names = c(str_glue("TES_TM{mt}"), str_glue("TEV_TM{mt}"))
    ) 
}

# control (delay-pre)
for (mc in 1:4) {
  if (
    !(str_glue("CM{mc}delay") %in% colnames(df_predelay)) | 
    !(str_glue("CM{mc}pre") %in% colnames(df_predelay))
  ) {
    next
  }
  df_predelay <-
    escalc(
      data = df_predelay,
      measure = "SMCR",
      m1i = df_predelay[, str_c("CM", mc, "delay")] %>% unlist(),
      m2i = df_predelay[, str_c("CM", mc, "pre")] %>% unlist(),
      sd1i = df_predelay[, str_c("CS", mc, "pre")] %>% unlist(),
      ni = df_predelay[, str_c("CN", mc, "delay")] %>% unlist(),
      ri = rep(0.5, 13),
      var.names = c(str_glue("CES_CM{mc}"), str_glue("CEV_CM{mc}"))
    ) 
}


# ES and EV taken together
for (m in 1:4) {
  if (
    !(str_glue("TES_TM{m}") %in% colnames(df_predelay)) | 
    !(str_glue("TEV_TM{m}") %in% colnames(df_predelay)) |
    !(str_glue("CES_CM{m}") %in% colnames(df_predelay)) | 
    !(str_glue("CEV_CM{m}") %in% colnames(df_predelay))
  ) {
    next
  }
  # subtracting effect size
  df_predelay[, str_c("ES_", m)] <- 
    (df_predelay[, str_c("TES_TM", m)] %>% unlist()) -
    (df_predelay[, str_c("CES_CM", m)] %>% unlist())
  # adding variance
  df_predelay[, str_c("EV_", m)] <- 
    (df_predelay[, str_c("TEV_TM", m)] %>% unlist()) +
    (df_predelay[, str_c("CEV_CM", m)] %>% unlist())
}


df_predelay <-
  df_predelay %>% 
  select(AUTYR, type, starts_with("ES")) %>% 
  pivot_longer(cols = starts_with("ES"), names_to = "num", values_to = "ES", values_drop_na = T) %>%
  mutate(num = str_sub(num, 4)) %>% 
  left_join(
    df_predelay %>% 
      select(AUTYR, type, starts_with("EV")) %>% 
      pivot_longer(cols = starts_with("EV"), names_to = "num", values_to = "EV", values_drop_na = T) %>% 
      mutate(num = str_sub(num, 4)),
    by = c("AUTYR", "type", "num")
  ) %>% 
  select(-num)
```

### Combining ES

```{r}
df_clean_delay <- 
  bind_rows(df_delay, df_predelay) %>% 
  left_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  ) %>%
  mutate(stdid = if_else(is.na(stdid), "Nelson11FU", stdid)) %>% 
  arrange(type, stdid) %>%
  select(type, stdid, ES, EV) %>%
  unite("type_stdid", c("type", "stdid")) %>% 
  agg(id = type_stdid, es = ES, var = EV, method = "BHHR", data = .) %>% 
  separate(id, c("type", "stdid")) %>% 
  rename(ES = es, EV = var) %>% 
  left_join(
    read_xlsx(data_file, sheet = "citations"),
    by = c("type", "stdid")
  ) %>% 
  mutate(
    citation = if_else(str_detect(type, "S$"), str_c(citation, " "), citation)
  )

df_clean_delay %>% summary()
rm(df_delay, df_predelay)
```

### Forest plots - Vocabulary

```{r}
model_1 <-
  df_clean_delay %>% 
  filter(type %in% c("VR", "VS")) %>% 
  arrange(desc(type), desc(ES)) %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation
  )

model_2 <-
  df_clean_delay %>% 
  filter(type == "VR") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = stdid
  )

model_3 <-
  df_clean_delay %>% 
  filter(type == "VS") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = stdid
  )

model_1
model_2
model_3
```

```{r,  out.width="100%", out.height="100%", fig.asp=1, fig.retina = 4}
forest(
  model_1,
  xlab = "Vocabulary - Delayed effects",
  addcred = T, 
  header = T,
  xlim = c(-9, 9),
  ylim = c(-1, 23),
  rows = c(3:5, 12:17),
  pch = 21,
  bg = "grey",
  lwd = 1.5
)
op <- par(cex = 0.75, font = 4)
text(-9, c(7, 19), pos = 4, c("Standardized Measure", "Custom Measure"))
addpoly(model_2, row = 10, cex = 1.25, col = "white", lwd = 3)
addpoly(model_3, row = 1.5, cex = 1.25, col = "white", lwd = 3)
```


### Forest plots - Reading Comprehension

```{r,  out.width="100%", out.height="100%", fig.retina = 4}
df_clean_delay %>% 
  filter(type %in% c("RR", "RS")) %>% 
  arrange(desc(type), desc(ES)) %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation
  )

df_clean_delay %>% 
  filter(type %in% c("RR", "RS")) %>% 
  arrange(desc(type), desc(ES)) %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML",
    slab = citation
  ) %>% 
  forest(
    xlab = "Reading Comprehension - Delayed effects",
    addcred = T, 
    header = T,
    pch = 21,
    bg = "grey",
    lwd = 1.5
  )
```



## Moderator Analysis

### Vocabulary - overall

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ Content)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ PD)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TMULT)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TVOC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TSYN)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TMOR)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TLC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TRC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TCOM)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TPAD)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ LowIncome)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ EL)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TDD)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TTEC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TSTR)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TWRT)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ CONT)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ Duration)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ Hours)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ design)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ grade)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ grouping)
```

### Vocabulary - overall (Controlling for type)

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ Content + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ PD + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TMULT + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TVOC + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TSYN + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TMOR + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TLC + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TRC + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TCOM + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TPAD + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ LowIncome + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ EL + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TDD + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TTEC + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TSTR + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ TWRT + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ CONT + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ Duration + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ Hours + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ design + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ grade + type)
rma(yi = ES, vi = EV, data = df_v, method = "REML", mods = ~ grouping + type)
```


### Vocabulary - VR

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ Content)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ PD)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TMULT)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TVOC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TSYN)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TMOR)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TLC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TRC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TCOM)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TPAD)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ LowIncome)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ EL)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TDD)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TTEC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TSTR)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ TWRT)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ CONT)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ Duration)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ Hours)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ design)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ grade)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VR"), mods = ~ grouping)
```


### Vocabulary - VS

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ Content)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ PD)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TMULT)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TVOC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TSYN)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TMOR)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TLC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TRC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TCOM)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TPAD)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ LowIncome)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ EL)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TDD)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TTEC)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TSTR)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ TWRT)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ CONT)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ Duration)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ Hours)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ design)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ grade)
rma(yi = ES, vi = EV, data = df_v, method = "REML", subset = (type == "VS"), mods = ~ grouping)
```



### Listening Comprehension - overall

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ Content)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ PD)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TMULT)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TVOC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TSYN)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TMOR)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TLC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TRC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TCOM)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TPAD)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ LowIncome)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ EL)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TDD)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TTEC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TSTR)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TWRT)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ CONT)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ Duration)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ Hours)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ design)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ grade)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ grouping)
```

### Listening Comprehension - overall (Controlling for type)

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ Content + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ PD + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TMULT + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TVOC + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TSYN + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TMOR + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TLC + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TRC + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TCOM + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TPAD + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ LowIncome + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ EL + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TDD + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TTEC + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TSTR + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ TWRT + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ CONT + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ Duration + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ Hours + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ design + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ grade + type)
rma(yi = ES, vi = EV, data = df_l, method = "REML", mods = ~ grouping + type)
```


### Listening Comprehension - LR

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ Content)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ PD)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TMULT)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TVOC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TSYN)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TMOR)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TLC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TRC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TCOM)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TPAD)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ LowIncome)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ EL)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TDD)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TTEC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TSTR)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ TWRT)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ CONT)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ Duration)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ Hours)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ design)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ grade)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LR"), mods = ~ grouping)
```


### Listening Comprehension - LS

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ Content)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ PD)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TMULT)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TVOC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TSYN)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TMOR)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TLC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TRC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TCOM)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TPAD)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ LowIncome)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ EL)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TDD)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TTEC)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TSTR)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ TWRT)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ CONT)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ Duration)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ Hours)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ design)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ grade)
rma(yi = ES, vi = EV, data = df_l, method = "REML", subset = (type == "LS"), mods = ~ grouping)
```


### Reading Comprehension - overall

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ Content)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ PD)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TMULT)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TVOC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TSYN)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TMOR)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TLC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TRC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TCOM)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TPAD)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ LowIncome)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ EL)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TDD)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TTEC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TSTR)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TWRT)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ CONT)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ Duration)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ Hours)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ design)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ grade)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ grouping)
```

### Reading Comprehension - overall (Controlling for type)

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ Content + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ PD + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TMULT + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TVOC + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TSYN + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TMOR + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TLC + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TRC + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TCOM + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TPAD + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ LowIncome + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ EL + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TDD + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TTEC + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TSTR + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ TWRT + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ CONT + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ Duration + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ Hours + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ design + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ grade + type)
rma(yi = ES, vi = EV, data = df_r, method = "REML", mods = ~ grouping + type)
```


### Reading Comprehension - RR

```{r, message=F, warning=F, error=T}
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ Content)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ PD)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TMULT)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TVOC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TSYN)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TMOR)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TLC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TRC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TCOM)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TPAD)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ LowIncome)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ EL)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TDD)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TTEC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TSTR)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ TWRT)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ CONT)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ Duration)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ Hours)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ design)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ grade)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RR"), mods = ~ grouping)
```


### Reading Comprehension - RS

```{r, message=F, warning=F}
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ Content)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ PD)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TMULT)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TVOC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TSYN)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TMOR)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TLC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TRC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TCOM)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TPAD)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ LowIncome)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ EL)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TDD)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TTEC)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TSTR)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ TWRT)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ CONT)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ Duration)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ Hours)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ design)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ grade)
rma(yi = ES, vi = EV, data = df_r, method = "REML", subset = (type == "RS"), mods = ~ grouping)
```


## EL vs EO

### EL

EL Post:


```{r}
read_post_data <- function(type, category) {
  read_xlsx(data_file, sheet = "ELs") %>% select(AUTYR = AUTH_YR, (ends_with(category) & contains(type))) %>% 
    rename_at(vars(-AUTYR), ~ str_replace(., type, "")) %>%
    rename_at(vars(-AUTYR), ~ str_replace(., category, "")) %>%
    drop_na(AUTYR) %>%
    filter(is.na(TM1pre)) %>% 
    select_if(~ any(!is.na(.))) %>%
    mutate(type = type) %>%
    select(AUTYR, type, sort(current_vars()))
}

df_el_post <-
  bind_rows(
    read_post_data("VR", "EL"),
    read_post_data("VS", "EL"),
    read_post_data("RR", "EL"),
    read_post_data("RS", "EL")
  )

for (m in 1:4) {
  if (
    !(str_glue("TM{m}post") %in% colnames(df_el_post)) | 
    !(str_glue("CM{m}post") %in% colnames(df_el_post))
  ) {
    next
  }
  df_el_post <-
    escalc(
      data = df_el_post,
      measure = "SMD",
      m1i = df_el_post[, str_c("TM", m, "post")] %>% unlist(),
      m2i = df_el_post[, str_c("CM", m, "post")] %>% unlist(),
      sd1i = df_el_post[, str_c("TS", m, "post")] %>% unlist(),
      sd2i = df_el_post[, str_c("CS", m, "post")] %>% unlist(),
      n1i = df_el_post[, str_c("TN", m, "post")] %>% unlist(),
      n2i = df_el_post[, str_c("CN", m, "post")] %>% unlist(),
      var.names = c(str_glue("ES_{m}"), str_glue("EV_{m}"))
    ) 
}

df_el_post <-
  df_el_post %>% 
  select(AUTYR, type, starts_with("ES")) %>% 
  pivot_longer(cols = starts_with("ES"), names_to = "num", values_to = "ES", values_drop_na = T) %>%
  mutate(num = str_sub(num, 4)) %>% 
  left_join(
    df_el_post %>% 
      select(AUTYR, type, starts_with("EV")) %>% 
      pivot_longer(cols = starts_with("EV"), names_to = "num", values_to = "EV", values_drop_na = T) %>% 
      mutate(num = str_sub(num, 4)),
    by = c("AUTYR", "type", "num")
  ) %>% 
  select(-num)
```


EL prepost:


```{r}
read_prepost_data <- function(type, category) {
  read_xlsx(data_file, sheet = "ELs") %>% select(AUTYR = AUTH_YR, (ends_with(category) & contains(type))) %>% 
    rename_at(vars(-AUTYR), ~ str_replace(., type, "")) %>%
    rename_at(vars(-AUTYR), ~ str_replace(., category, "")) %>%
    drop_na(AUTYR) %>%
    filter(!is.na(TM1pre)) %>% 
    select_if(~ any(!is.na(.))) %>%
    mutate(type = type) %>%
    select(AUTYR, type, sort(current_vars()))
}

df_el_prepost <-
  bind_rows(
    read_prepost_data("VR", "EL"),
    read_prepost_data("VS", "EL"),
    read_prepost_data("RR", "EL"),
    read_prepost_data("RS", "EL")
  ) %>% 
  mutate(
    TN1post = if_else(is.na(TN1post) & !is.na(TN1pre), TN1pre, TN1post),
    TN2post = if_else(is.na(TN2post) & !is.na(TN2pre), TN2pre, TN2post),
    CN1post = if_else(is.na(CN1post) & !is.na(CN1pre), CN1pre, CN1post),
    CN2post = if_else(is.na(CN2post) & !is.na(CN2pre), CN2pre, CN2post)
  )

# treatment (post-pre)
for (mt in 1:4) {
  if (
    !(str_glue("TM{mt}post") %in% colnames(df_el_prepost)) | 
    !(str_glue("TM{mt}pre") %in% colnames(df_el_prepost))
  ) {
    next
  }
  df_el_prepost <-
    escalc(
      data = df_el_prepost,
      measure = "SMCR",
      m1i = df_el_prepost[, str_c("TM", mt, "post")] %>% unlist(),
      m2i = df_el_prepost[, str_c("TM", mt, "pre")] %>% unlist(),
      sd1i = df_el_prepost[, str_c("TS", mt, "pre")] %>% unlist(),
      ni = df_el_prepost[, str_c("TN", mt, "post")] %>% unlist(),
      ri = rep(0.5, 11),
      var.names = c(str_glue("TES_TM{mt}"), str_glue("TEV_TM{mt}"))
    ) 
}

# control (post-pre)
for (mc in 1:4) {
  if (
    !(str_glue("CM{mc}post") %in% colnames(df_el_prepost)) | 
    !(str_glue("CM{mc}pre") %in% colnames(df_el_prepost))
  ) {
    next
  }
  df_el_prepost <-
    escalc(
      data = df_el_prepost,
      measure = "SMCR",
      m1i = df_el_prepost[, str_c("CM", mc, "post")] %>% unlist(),
      m2i = df_el_prepost[, str_c("CM", mc, "pre")] %>% unlist(),
      sd1i = df_el_prepost[, str_c("CS", mc, "pre")] %>% unlist(),
      ni = df_el_prepost[, str_c("CN", mc, "post")] %>% unlist(),
      ri = rep(0.5, 11),
      var.names = c(str_glue("CES_CM{mc}"), str_glue("CEV_CM{mc}"))
    ) 
}


# ES and EV taken together
for (m in 1:4) {
  if (
    !(str_glue("TES_TM{m}") %in% colnames(df_el_prepost)) | 
    !(str_glue("TEV_TM{m}") %in% colnames(df_el_prepost)) |
    !(str_glue("CES_CM{m}") %in% colnames(df_el_prepost)) | 
    !(str_glue("CEV_CM{m}") %in% colnames(df_el_prepost))
  ) {
    next
  }
  # subtracting effect size
  df_el_prepost[, str_c("ES_", m)] <- 
    (df_el_prepost[, str_c("TES_TM", m)] %>% unlist()) -
    (df_el_prepost[, str_c("CES_CM", m)] %>% unlist())
  # adding variance
  df_el_prepost[, str_c("EV_", m)] <- 
    (df_el_prepost[, str_c("TEV_TM", m)] %>% unlist()) +
    (df_el_prepost[, str_c("CEV_CM", m)] %>% unlist())
}


df_el_prepost <-
  df_el_prepost %>% 
  select(AUTYR, type, starts_with("ES")) %>% 
  pivot_longer(cols = starts_with("ES"), names_to = "num", values_to = "ES", values_drop_na = T) %>%
  mutate(num = str_sub(num, 4)) %>% 
  left_join(
    df_el_prepost %>% 
      select(AUTYR, type, starts_with("EV")) %>% 
      pivot_longer(cols = starts_with("EV"), names_to = "num", values_to = "EV", values_drop_na = T) %>% 
      mutate(num = str_sub(num, 4)),
    by = c("AUTYR", "type", "num")
  ) %>% 
  select(-num)
```


### EO

EO Post:


```{r}
read_post_data <- function(type, category) {
  read_xlsx(data_file, sheet = "ELs") %>% select(AUTYR = AUTH_YR, (ends_with(category) & contains(type))) %>% 
    rename_at(vars(-AUTYR), ~ str_replace(., type, "")) %>%
    rename_at(vars(-AUTYR), ~ str_replace(., category, "")) %>%
    drop_na(AUTYR) %>%
    filter(is.na(TM1pre)) %>% 
    select_if(~ any(!is.na(.))) %>%
    mutate(type = type) %>%
    select(AUTYR, type, sort(current_vars()))
}

df_eo_post <-
  bind_rows(
    read_post_data("VR", "EO"),
    read_post_data("VS", "EO"),
    read_post_data("RR", "EO"),
    read_post_data("RS", "EO")
  )

for (m in 1:4) {
  if (
    !(str_glue("TM{m}post") %in% colnames(df_eo_post)) | 
    !(str_glue("CM{m}post") %in% colnames(df_eo_post))
  ) {
    next
  }
  df_eo_post <-
    escalc(
      data = df_eo_post,
      measure = "SMD",
      m1i = df_eo_post[, str_c("TM", m, "post")] %>% unlist(),
      m2i = df_eo_post[, str_c("CM", m, "post")] %>% unlist(),
      sd1i = df_eo_post[, str_c("TS", m, "post")] %>% unlist(),
      sd2i = df_eo_post[, str_c("CS", m, "post")] %>% unlist(),
      n1i = df_eo_post[, str_c("TN", m, "post")] %>% unlist(),
      n2i = df_eo_post[, str_c("CN", m, "post")] %>% unlist(),
      var.names = c(str_glue("ES_{m}"), str_glue("EV_{m}"))
    ) 
}

df_eo_post <-
  df_eo_post %>% 
  select(AUTYR, type, starts_with("ES")) %>% 
  pivot_longer(cols = starts_with("ES"), names_to = "num", values_to = "ES", values_drop_na = T) %>%
  mutate(num = str_sub(num, 4)) %>% 
  left_join(
    df_eo_post %>% 
      select(AUTYR, type, starts_with("EV")) %>% 
      pivot_longer(cols = starts_with("EV"), names_to = "num", values_to = "EV", values_drop_na = T) %>% 
      mutate(num = str_sub(num, 4)),
    by = c("AUTYR", "type", "num")
  ) %>% 
  select(-num)
```


EO prepost:


```{r}
read_prepost_data <- function(type, category) {
  read_xlsx(data_file, sheet = "ELs") %>% select(AUTYR = AUTH_YR, (ends_with(category) & contains(type))) %>% 
    rename_at(vars(-AUTYR), ~ str_replace(., type, "")) %>%
    rename_at(vars(-AUTYR), ~ str_replace(., category, "")) %>%
    drop_na(AUTYR) %>%
    filter(!is.na(TM1pre)) %>% 
    select_if(~ any(!is.na(.))) %>%
    mutate(type = type) %>%
    select(AUTYR, type, sort(current_vars()))
}

df_eo_prepost <-
  bind_rows(
    read_prepost_data("VR", "EO"),
    read_prepost_data("VS", "EO"),
    read_prepost_data("RR", "EO"),
    read_prepost_data("RS", "EO")
  ) %>% 
  mutate(
    TN1post = if_else(is.na(TN1post) & !is.na(TN1pre), TN1pre, TN1post),
    TN2post = if_else(is.na(TN2post) & !is.na(TN2pre), TN2pre, TN2post),
    CN1post = if_else(is.na(CN1post) & !is.na(CN1pre), CN1pre, CN1post),
    CN2post = if_else(is.na(CN2post) & !is.na(CN2pre), CN2pre, CN2post)
  )

# treatment (post-pre)
for (mt in 1:4) {
  if (
    !(str_glue("TM{mt}post") %in% colnames(df_eo_prepost)) | 
    !(str_glue("TM{mt}pre") %in% colnames(df_eo_prepost))
  ) {
    next
  }
  df_eo_prepost <-
    escalc(
      data = df_eo_prepost,
      measure = "SMCR",
      m1i = df_eo_prepost[, str_c("TM", mt, "post")] %>% unlist(),
      m2i = df_eo_prepost[, str_c("TM", mt, "pre")] %>% unlist(),
      sd1i = df_eo_prepost[, str_c("TS", mt, "pre")] %>% unlist(),
      ni = df_eo_prepost[, str_c("TN", mt, "post")] %>% unlist(),
      ri = rep(0.5, 11),
      var.names = c(str_glue("TES_TM{mt}"), str_glue("TEV_TM{mt}"))
    ) 
}

# control (post-pre)
for (mc in 1:4) {
  if (
    !(str_glue("CM{mc}post") %in% colnames(df_eo_prepost)) | 
    !(str_glue("CM{mc}pre") %in% colnames(df_eo_prepost))
  ) {
    next
  }
  df_eo_prepost <-
    escalc(
      data = df_eo_prepost,
      measure = "SMCR",
      m1i = df_eo_prepost[, str_c("CM", mc, "post")] %>% unlist(),
      m2i = df_eo_prepost[, str_c("CM", mc, "pre")] %>% unlist(),
      sd1i = df_eo_prepost[, str_c("CS", mc, "pre")] %>% unlist(),
      ni = df_eo_prepost[, str_c("CN", mc, "post")] %>% unlist(),
      ri = rep(0.5, 11),
      var.names = c(str_glue("CES_CM{mc}"), str_glue("CEV_CM{mc}"))
    ) 
}


# ES and EV taken together
for (m in 1:4) {
  if (
    !(str_glue("TES_TM{m}") %in% colnames(df_eo_prepost)) | 
    !(str_glue("TEV_TM{m}") %in% colnames(df_eo_prepost)) |
    !(str_glue("CES_CM{m}") %in% colnames(df_eo_prepost)) | 
    !(str_glue("CEV_CM{m}") %in% colnames(df_eo_prepost))
  ) {
    next
  }
  # subtracting effect size
  df_eo_prepost[, str_c("ES_", m)] <- 
    (df_eo_prepost[, str_c("TES_TM", m)] %>% unlist()) -
    (df_eo_prepost[, str_c("CES_CM", m)] %>% unlist())
  # adding variance
  df_eo_prepost[, str_c("EV_", m)] <- 
    (df_eo_prepost[, str_c("TEV_TM", m)] %>% unlist()) +
    (df_eo_prepost[, str_c("CEV_CM", m)] %>% unlist())
}


df_eo_prepost <-
  df_eo_prepost %>% 
  select(AUTYR, type, starts_with("ES")) %>% 
  pivot_longer(cols = starts_with("ES"), names_to = "num", values_to = "ES", values_drop_na = T) %>%
  mutate(num = str_sub(num, 4)) %>% 
  left_join(
    df_eo_prepost %>% 
      select(AUTYR, type, starts_with("EV")) %>% 
      pivot_longer(cols = starts_with("EV"), names_to = "num", values_to = "EV", values_drop_na = T) %>% 
      mutate(num = str_sub(num, 4)),
    by = c("AUTYR", "type", "num")
  ) %>% 
  select(-num)
```


### Joining

```{r}
# EL
df_el_clean <- 
  bind_rows(df_el_post, df_el_prepost) %>% 
  left_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  ) %>%
  arrange(type, stdid) %>%
  select(type, stdid, AUTYR, ES, EV) %>%
  unite("type_stdid", c("type", "stdid")) %>% 
  agg(id = type_stdid, es = ES, var = EV, method = "BHHR", data = .) %>% 
  separate(id, c("type", "stdid")) %>% 
  rename(ES = es, EV = var)

# EO
df_eo_clean <- 
  bind_rows(df_eo_post, df_eo_prepost) %>% 
  left_join(
    read_xlsx(data_file, sheet = "StudyChar") %>% 
      drop_na(AUTYR),
    by = "AUTYR"
  ) %>%
  arrange(type, stdid) %>%
  select(type, stdid, AUTYR, ES, EV) %>%
  unite("type_stdid", c("type", "stdid")) %>% 
  agg(id = type_stdid, es = ES, var = EV, method = "BHHR", data = .) %>% 
  separate(id, c("type", "stdid")) %>% 
  rename(ES = es, EV = var)

rm(df_el_post, df_el_prepost, df_eo_post,  df_eo_prepost)
df_el_clean %>% datatable()
df_eo_clean %>% datatable()
```


### Calculating Effect Sizes

```{r}
# EL
df_el_clean %>%
  filter(type == "VR") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_el_clean %>%
  filter(type == "VS") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_el_clean %>%
  filter(type == "RR") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_el_clean %>%
  filter(type == "RS") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

# EO
df_eo_clean %>%
  filter(type == "VR") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_eo_clean %>%
  filter(type == "VS") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_eo_clean %>%
  filter(type == "RR") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_eo_clean %>%
  filter(type == "RS") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )
```

```{r}
# Combined
# EL
df_el_clean %>%
  filter(type == "VR" | type == "VS") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_el_clean %>%
  filter(type == "RR" | type == "RS") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

# EO
df_eo_clean %>%
  filter(type == "VR" | type == "VS") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_eo_clean %>%
  filter(type == "RR" | type == "RS") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )


# # Difference
# bind_rows(
#   df_el_clean %>% mutate(els = "EL"),
#   df_eo_clean %>% mutate(els = "EO")
# ) %>% 
#   mutate(els = els %>% as_factor()) %>% 
#   filter(type == "RR"| type == "RS") %>% 
#   rma(
#     yi = ES, 
#     vi = EV, 
#     data = .,
#     mods = ~ els,
#     method = "REML"
#   )
```



## Publication Bias

### Funnel plots

```{r}
df_v %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    mods = ~ type * grouping * TMULT,
    method = "REML"
  ) %>% 
  funnel(xlab = "Vocabulary Effect Size")

df_l %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    mods = ~ type * grouping * TMULT,
    method = "REML"
  ) %>% 
  funnel(xlab = "Listening Comprehension Effect Size")

df_r %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = .,
    mods = ~ type * grouping * TMULT,
    method = "REML"
  ) %>% 
  funnel(xlab = "Reading Comprehension Effect Size")
```

### Egger's Test

```{r}
# Vocabulary
df_v %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    mods = ~ type * grouping * TMULT,
    method = "REML"
  ) %>%
  regtest(model = "rma", predictor = "sei")

# Listening Comp.
df_l %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    mods = ~ type * grouping * TMULT,
    method = "REML"
  ) %>%
  regtest(model = "rma", predictor = "sei")

# Reading Comp.
df_r %>%
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    mods = ~ type * grouping * TMULT,
    method = "REML"
  ) %>% 
  regtest(model = "rma", predictor = "sei")
```


### P Curves

```{r, error = T}
# Vocabulary
df_v %>% 
  mutate(
    SE = sqrt(EV)
  ) %>% 
  meta::metagen(
    ES,
    SE,
    data = .,
    comb.fixed = F,
    comb.random = T,
    method.tau = "REML",
    hakn = T,
    sm = "SMD"
  ) %>% 
  pcurve()


# Reading Comp
df_r %>% 
  mutate(
    SE = sqrt(EV)
  ) %>% 
  meta::metagen(
    ES,
    SE,
    data = .,
    comb.fixed = F,
    comb.random = T,
    method.tau = "REML",
    hakn = T,
    sm = "SMD"
  ) %>% 
  pcurve()

# Listening Comp
df_l %>%
  mutate(
    SE = sqrt(EV)
  ) %>%
  meta::metagen(
    ES,
    SE,
    data = .,
    comb.fixed = F,
    comb.random = T,
    method.tau = "REML",
    hakn = T,
    sm = "SMD"
  ) %>%
  pcurve()
```


## Risk of bias analysis

```{r, fig.retina=4}
source("rob_summary.R")
df_append %>% 
  mutate(Selection = if_else(RCT == 1, "Low", "High")) %>% 
  distinct(stdid, Selection, Performance, Detection, Attrition, Reporting) %>%
  select(stdid, Selection, Performance, Detection, Attrition, Reporting) %>%
  mutate_at(vars(Selection:Reporting), ~ recode(., "H" = "High", "L" = "Low", "U" = "Unclear")) %>%
  mutate_at(vars(Selection:Reporting), ~ factor(., levels = c("High", "Low", "Unclear"), ordered = T)) %>%
  rename(Study = stdid, `Selection bias` = Selection, `Performance bias` = Performance, `Detection bias` = Detection, `Attrition bias` = Attrition, `Reporting bias` = Reporting) %>%
  left_join(
    cor_es %>%
      group_by(stdid) %>%
      summarise(EV = mean(EV, na.rm = T)) %>%
      transmute(Study = stdid, Overall = factor("Low"), Weight = 1/EV %>% as.numeric()),
    by = "Study"
  ) %>%
  mutate(Study = Study %>% as_factor()) %>%
  rob_summary(tool = "ROB1")
```

## Sensitivity analyses

### Exclude high selection risk studies

```{r}
df_append %>%
  filter(type %in% c("VR", "VS")) %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_l %>%
  filter(design == "RCT") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_r %>%
  filter(design == "RCT") %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )
```


### Capping outliers

```{r}
df_v %>%
  mutate(
    ES = if_else(
      ES %in% boxplot(.$ES, plot = FALSE)$out, 
      quantile(.$ES, probs = 0.75, na.rm = T) + 1.5 * IQR(.$ES, na.rm = T), 
      ES
    )
  ) %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )

df_l %>%
  mutate(
    ES = if_else(
      ES %in% boxplot(.$ES, plot = FALSE)$out, 
      quantile(.$ES, probs = 0.75, na.rm = T) + 1.5 * IQR(.$ES, na.rm = T), 
      ES
    )
  ) %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )


df_r %>%
  mutate(
    ES = if_else(
      ES %in% boxplot(.$ES, plot = FALSE)$out, 
      quantile(.$ES, probs = 0.75, na.rm = T) + 1.5 * IQR(.$ES, na.rm = T), 
      ES
    )
  ) %>% 
  rma(
    yi = ES, 
    vi = EV, 
    data = ., 
    method = "REML"
  )
```


### Change within study correlations


```{r}
df_v %>% 
  robu(
    formula = ES ~ 1, 
    var.eff.size = EV, 
    studynum = stdid,
    data = ., 
    modelweights = "CORR"
    ) %>% 
  sensitivity()

df_r %>% 
  robu(
    formula = ES ~ 1, 
    var.eff.size = EV, 
    studynum = stdid,
    data = ., 
    modelweights = "CORR"
    ) %>% 
  sensitivity()

df_l %>% 
  robu(
    formula = ES ~ 1, 
    var.eff.size = EV, 
    studynum = stdid,
    data = ., 
    modelweights = "CORR"
    ) %>% 
  sensitivity()
```


## MetaForest plots

### Vocabulary

```{r, fig.retina = 4, eval = F}
df_v %>%
  rename(vi = EV) %>%
  mutate(stdid = stdid %>% as_factor()) %>% 
  drop_na(Hours, LowIncome) %>% 
  MetaForest(
    formula = ES ~ .,
    data = .,
    study = "stdid"
  ) %>%
  preselect(replications = 500L) %>% 
  plot()
```

### Listening Comprehension

```{r, fig.retina = 4, eval = F}
df_l %>%
  rename(vi = EV) %>%
  mutate(stdid = stdid %>% as_factor()) %>% 
  drop_na(Hours, LowIncome) %>%
  MetaForest(
    formula = ES ~ .,
    data = .,
    study = "stdid"
  ) %>%
  preselect(replications = 500L) %>% 
  plot()
```


### Reading Comprehension

```{r, fig.retina = 4, eval = F}
df_r %>%
  rename(vi = EV) %>%
  mutate(stdid = stdid %>% as_factor()) %>% 
  drop_na(Hours, LowIncome) %>% 
  MetaForest(
    formula = ES ~ .,
    data = .,
    study = "stdid"
  ) %>%
  preselect(replications = 500L) %>% 
  plot()
```




